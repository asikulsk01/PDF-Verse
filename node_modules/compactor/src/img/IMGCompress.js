const { createCanvas } = require('canvas');
const { createCanvasContext, getFileName, getImageObject, setCompressedFileFields } = require('../util/FileUtils');
const { getPreFix } = require('../util/Base64Utils');

async function compressIMG(inputFile, callbackFunc, options) {
  const image = await getImageObject(getPreFix('image/jpeg') + inputFile.bytes);

  const width = image.width;
  const height = image.height;

  const canvas = createCanvas(width, height);
  const canvasContext = createCanvasContext(canvas);
  canvasContext.drawImage(image, 0, 0, width, height);

  const base64String = await new Promise((resolve, _) =>
    resolve(canvas.toDataURL('image/jpeg', options.pageQuality))
  );

  inputFile.fileName = getFileName(inputFile.fileName) + '.jpg';
  inputFile.mimeType = 'image/jpeg';
  setCompressedFileFields(inputFile, base64String);

  callbackFunc(inputFile);
}

module.exports = { compressIMG };
